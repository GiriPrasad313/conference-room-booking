# CI/CD Pipeline for Conference Room Booking System
# Triggers on push to main and feature branches
# Builds, tests, and deploys all microservices

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop, 'feature/*']
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com
  EC2_HOST: ${{ secrets.EC2_HOST }}

jobs:
  # ============================================
  # Job 1: Lint and Test All Services
  # ============================================
  test:
    name: Test Services
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        service:
          - auth-service
          - rooms-service
          - booking-service
          - email-worker
    
    defaults:
      run:
        working-directory: services/${{ matrix.service }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: services/${{ matrix.service }}/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint --if-present

      - name: Run tests
        run: npm test -- --coverage --ci
        env:
          NODE_ENV: test

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          directory: services/${{ matrix.service }}/coverage
          flags: ${{ matrix.service }}

  # ============================================
  # Job 2: Test Python Weather Service
  # ============================================
  test-weather:
    name: Test Weather Service
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: services/weather-service

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run tests
        run: pytest --cov=src --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          directory: services/weather-service
          flags: weather-service

  # ============================================
  # Job 3: Build Docker Images
  # ============================================
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [test, test-weather]
    if: github.ref == 'refs/heads/main'
    
    strategy:
      matrix:
        service:
          - auth-service
          - rooms-service
          - booking-service
          - weather-service
          - email-worker
          - api-gateway

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        run: |
          SERVICE=${{ matrix.service }}
          IMAGE_TAG=${{ github.sha }}
          
          # Special case for API Gateway (nginx config)
          if [ "$SERVICE" = "api-gateway" ]; then
            DOCKERFILE_PATH="services/api-gateway"
            # Create a simple Dockerfile for nginx
            echo "FROM nginx:alpine" > $DOCKERFILE_PATH/Dockerfile.tmp
            echo "COPY nginx.conf /etc/nginx/nginx.conf" >> $DOCKERFILE_PATH/Dockerfile.tmp
            echo "EXPOSE 80" >> $DOCKERFILE_PATH/Dockerfile.tmp
            echo 'CMD ["nginx", "-g", "daemon off;"]' >> $DOCKERFILE_PATH/Dockerfile.tmp
            docker build -t $ECR_REGISTRY/$SERVICE:$IMAGE_TAG -f $DOCKERFILE_PATH/Dockerfile.tmp $DOCKERFILE_PATH
          else
            docker build -t $ECR_REGISTRY/$SERVICE:$IMAGE_TAG services/$SERVICE
          fi
          
          docker push $ECR_REGISTRY/$SERVICE:$IMAGE_TAG
          docker tag $ECR_REGISTRY/$SERVICE:$IMAGE_TAG $ECR_REGISTRY/$SERVICE:latest
          docker push $ECR_REGISTRY/$SERVICE:latest

  # ============================================
  # Job 4: Deploy to EC2
  # ============================================
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ec2-user/conference-room-booking
            
            # Login to ECR
            aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}
            
            # Pull latest images
            docker-compose pull
            
            # Deploy with zero-downtime
            docker-compose up -d --no-deps --build
            
            # Clean up old images
            docker image prune -f
            
            # Health check
            sleep 10
            curl -f http://localhost/health || exit 1

      - name: Notify deployment success
        if: success()
        run: echo "✅ Deployment successful!"

      - name: Notify deployment failure
        if: failure()
        run: echo "❌ Deployment failed!"

  # ============================================
  # Job 5: Integration Tests (Post-Deploy)
  # ============================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run integration tests
        run: |
          # Basic health check on all services
          SERVICES=("auth" "rooms" "bookings" "weather")
          
          for service in "${SERVICES[@]}"; do
            echo "Testing $service endpoint..."
            curl -f http://${{ secrets.EC2_HOST }}/api/$service/health || exit 1
          done
          
          echo "✅ All integration tests passed!"
